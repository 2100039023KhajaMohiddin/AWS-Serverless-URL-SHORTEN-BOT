import json
import urllib.parse
import urllib.request

def shorten_url(long_url):
    api_url = f'http://tinyurl.com/api-create.php?url={long_url}'
    with urllib.request.urlopen(api_url) as response:
        return response.read().decode()

def send_telegram_message(chat_id, text):
    BOT_TOKEN = '7258418881:AAGKNf7rcR5rsWYEn6u0sjlF25uy1-7-22Q'  # Replace with your bot token
    url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
    data = {"chat_id": chat_id, "text": text}
    req = urllib.request.Request(url, data=json.dumps(data).encode(), headers={'Content-Type': 'application/json'})
    urllib.request.urlopen(req)

def lambda_handler(event, context):
    body = json.loads(event["body"])
    chat_id = body['message']['chat']['id']
    message = body['message']['text']
    
    if message.startswith("http"):
        shortened_url = shorten_url(message)
        send_telegram_message(chat_id, shortened_url)
    else:
        send_telegram_message(chat_id, "Please send a valid URL.")
    
    return {
        'statusCode': 200,
        'body': json.dumps('Message processed successfully!')
    }
